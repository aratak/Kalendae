/********************************************************************
 *	Kalendae, a framework agnostic javascript date picker           *
 *	Copyright(c) 2012 Jarvis Badgley (chipersoft@gmail.com)         *
 *	http://github.com/ChiperSoft/Kalendae                           *
 *	Version 0.3                                                     *
 ********************************************************************/

(function(){var m,i=function(a,b){if("function"===typeof document.addEventListener||e.isIE8()){var c=!1;try{c=a instanceof Element}catch(h){c=!!a&&1===c.nodeType}c||"string"===typeof a||(b=a);var d=this,f=d.classes,g=d.settings=e.merge(d.defaults,{attachTo:a},b||{}),c=d.container=e.make("div",{"class":f.container}),i=d.calendars=[],p=moment().day(g.weekStart),j,l=[],n,k,m;n=[];var r;k=0;j=g.months;e.isIE8()&&e.addClassName(c,"ie8");for(k=7;k--;)l.push(p.format(g.columnHeaderFormat)),p.add("days",
1);t(d);if("object"===typeof g.subscribe)for(k in g.subscribe)g.subscribe.hasOwnProperty(k)&&d.subscribe(k,g.subscribe[k]);d._sel=[];g.selected&&d.setSelected(g.selected,!1);j=g.viewStartDate?moment(g.viewStartDate,g.format):0<d._sel.length?moment(d._sel[0]):moment();d.viewStartDate=j.date(1);if((j={past:g.months-1,"today-past":g.months-1,any:2<g.months?Math.floor(g.months/2):0,"today-future":0,future:0}[this.settings.direction])&&moment().month()==moment(d.viewStartDate).month())d.viewStartDate=
moment(d.viewStartDate).subtract({M:j}).date(1);if("function"===typeof g.blackout)d.blackout=g.blackout;else if(g.blackout){var s=q(g.blackout,g.parseSplitDelimiter,g.format);d.blackout=function(a){a=moment(a).yearDay();if(1>a||!d._sel)return!1;for(var c=s.length;c--;)if(s[c].yearDay()===a)return!0;return!1}}else d.blackout=function(){return!1};d.direction=d.directions[g.direction]?d.directions[g.direction]:d.directions.any;for(j=Math.max(g.months,1);j--;){n=e.make("div",{"class":f.calendar},c);n.setAttribute("data-cal-index",
j);1<g.months&&(j==Math.max(g.months-1,1)?e.addClassName(n,f.monthFirst):0===j?e.addClassName(n,f.monthLast):e.addClassName(n,f.monthMiddle));k=e.make("div",{"class":f.title},n);g.useYearNav||e.addClassName(k,f.disableYearNav);e.make("a",{"class":f.previousYear},k);e.make("a",{"class":f.previousMonth},k);e.make("a",{"class":f.nextYear},k);e.make("a",{"class":f.nextMonth},k);p=e.make("span",{"class":f.caption},k);m=e.make("div",{"class":f.header},n);k=0;do r=e.make("span",{},m),r.innerHTML=l[k];while(7>
++k);m=e.make("div",{"class":f.days},n);k=0;for(n=[];42>k++;)n.push(e.make("span",{},m));i.push({caption:p,days:n});j&&e.make("div",{"class":f.monthSeparator},c)}d.draw();e.addEvent(c,"mousedown",function(a,c){var b;if(e.hasClassName(c,f.nextMonth))!d.disableNext&&!1!==d.publish("view-changed",d,["next-month"])&&(d.viewStartDate.add("months",1),d.draw());else if(e.hasClassName(c,f.previousMonth))!d.disablePreviousMonth&&!1!==d.publish("view-changed",d,["previous-month"])&&(d.viewStartDate.subtract("months",
1),d.draw());else if(e.hasClassName(c,f.nextYear))!d.disableNext&&!1!==d.publish("view-changed",d,["next-year"])&&(d.viewStartDate.add("years",1),d.draw());else if(e.hasClassName(c,f.previousYear))!d.disablePreviousMonth&&!1!==d.publish("view-changed",d,["previous-year"])&&(d.viewStartDate.subtract("years",1),d.draw());else if(e.hasClassName(c.parentNode,f.days)&&e.hasClassName(c,f.dayActive)&&(b=c.getAttribute("data-date")))if(b=moment(b,g.dayAttributeFormat).hours(12),!1!==d.publish("date-clicked",
d,[b]))switch(g.mode){case "multiple":d.addSelected(b)||d.removeSelected(b);break;case "range":d.addSelected(b);break;default:d.addSelected(b)}return!1});(g.attachTo=e.$(g.attachTo))&&g.attachTo.appendChild(c)}};i.prototype={defaults:{attachTo:null,months:1,weekStart:0,direction:"any",directionScrolling:!0,viewStartDate:null,blackout:null,selected:null,mode:"single",dayOutOfMonthClickable:!1,format:null,subscribe:null,columnHeaderFormat:"dd",titleFormat:"MMMM, YYYY",dayNumberFormat:"D",dayAttributeFormat:"YYYY-MM-DD",
parseSplitDelimiter:/,\s*|\s+-\s+/,rangeDelimiter:" - ",multipleDelimiter:", ",useYearNav:!0,dateClassMap:{}},classes:{container:"kalendae",calendar:"k-calendar",monthFirst:"k-first-month",monthMiddle:"k-middle-month",monthLast:"k-last-month",title:"k-title",previousMonth:"k-btn-previous-month",nextMonth:"k-btn-next-month",previousYear:"k-btn-previous-year",nextYear:"k-btn-next-year",caption:"k-caption",header:"k-header",days:"k-days",dayOutOfMonth:"k-out-of-month",dayInMonth:"k-in-month",dayActive:"k-active",
daySelected:"k-selected",dayInRange:"k-range",dayToday:"k-today",monthSeparator:"k-separator",disablePreviousMonth:"k-disable-previous-month-btn",disableNextMonth:"k-disable-next-month-btn",disablePreviousYear:"k-disable-previous-year-btn",disableNextYear:"k-disable-next-year-btn",disableYearNav:"k-disable-year-nav"},disablePreviousMonth:!1,disableNextMonth:!1,disablePreviousYear:!1,disableNextYear:!1,directions:{past:function(a){return moment(a).yearDay()>=m.yearDay()},"today-past":function(a){return moment(a).yearDay()>
m.yearDay()},any:function(){return!1},"today-future":function(a){return moment(a).yearDay()<m.yearDay()},future:function(a){return moment(a).yearDay()<=m.yearDay()}},getSelectedAsDates:function(){for(var a=[],b=0,c=this._sel.length;b<c;b++)a.push(this._sel[b].toDate());return a},getSelectedAsText:function(a){for(var b=[],c=0,e=this._sel.length;c<e;c++)b.push(this._sel[c].format(a||this.settings.format||"YYYY-MM-DD"));return b},getSelectedRaw:function(){for(var a=[],b=0,c=this._sel.length;b<c;b++)a.push(moment(this._sel[b]));
return a},getSelected:function(a){a=this.getSelectedAsText(a);switch(this.settings.mode){case "range":return a.splice(2),a.join(this.settings.rangeDelimiter);case "multiple":return a.join(this.settings.multipleDelimiter);default:return a[0]}},isSelected:function(a){a=moment(a).yearDay();if(1>a||!this._sel||1>this._sel.length)return!1;switch(this.settings.mode){case "range":var b=this._sel[0]?this._sel[0].yearDay():0,c=this._sel[1]?this._sel[1].yearDay():0;return b===a||c===a?1:!b||!c?0:a>b&&a<c||
b<c&&a<b&&a>c?-1:!1;case "multiple":for(b=this._sel.length;b--;)if(this._sel[b].yearDay()===a)return!0;return!1;default:return this._sel[0]&&this._sel[0].yearDay()===a}},setSelected:function(a,b){for(var c=q(a,this.settings.parseSplitDelimiter,this.settings.format),e=q(this.getSelected(),this.settings.parseSplitDelimiter,this.settings.format),d=e.length;d--;)this.removeSelected(e[d],b);for(d=c.length;d--;)this.addSelected(c[d],b);!1!==b&&this.draw()},addSelected:function(a,b){a=moment(a,this.settings.format).hours(12);
this.settings.dayOutOfMonthClickable&&"range"!==this.settings.mode&&this.makeSelectedDateVisible(a);switch(this.settings.mode){case "multiple":if(this.isSelected(a))return!1;this._sel.push(a);break;case "range":1!==this._sel.length?this._sel=[a]:a.yearDay()>this._sel[0].yearDay()?this._sel[1]=a:this._sel=[a,this._sel[0]];break;default:this._sel=[a]}this._sel.sort(function(a,b){return a.yearDay()-b.yearDay()});this.publish("change",this,[a,"select"]);!1!==b&&this.draw();return!0},makeSelectedDateVisible:function(a){outOfViewMonth=
moment(a).date("1").diff(this.viewStartDate,"months");0>outOfViewMonth?this.viewStartDate.subtract("months",1):0<outOfViewMonth&&outOfViewMonth>=this.settings.months&&this.viewStartDate.add("months",1)},removeSelected:function(a,b){for(var a=moment(a,this.settings.format).hours(12),c=this._sel.length;c--;)if(this._sel[c].yearDay()===a.yearDay())return this._sel.splice(c,1),this.publish("change",this,[a,"remove"]),!1!==b&&this.draw(),!0;return!1},draw:function(){var a=moment(this.viewStartDate).hours(12),
b,c=this.classes,h,d,f,g=0,i,p=0,j,l=this.settings;i=this.calendars.length;do{b=moment(a).date(1);b.day(b.day()<this.settings.weekStart?this.settings.weekStart-7:this.settings.weekStart);h=this.calendars[g];h.caption.innerHTML=a.format(this.settings.titleFormat);p=0;do d=h.days[p],f=[],(j=this.isSelected(b))&&f.push({"-1":c.dayInRange,1:c.daySelected,"true":c.daySelected}[j]),b.month()!=a.month()?f.push(c.dayOutOfMonth):f.push(c.dayInMonth),(!this.blackout(b)&&!(this.direction(b)||b.month()!=a.month()&&
!1===l.dayOutOfMonthClickable)||0<j)&&f.push(c.dayActive),b.yearDay()===m.yearDay()&&f.push(c.dayToday),j=b.format(this.settings.dayAttributeFormat),l.dateClassMap[j]&&f.push(l.dateClassMap[j]),d.innerHTML=b.format(l.dayNumberFormat),d.className=f.join(" "),d.setAttribute("data-date",j),b.add("days",1);while(42>++p);a.add("months",1)}while(++g<i);if(l.directionScrolling){b=-moment().diff(a,"months");if("today-past"===l.direction||"past"===l.direction)0>b?(this.disableNextMonth=!1,e.removeClassName(this.container,
c.disableNextMonth)):(this.disableNextMonth=!0,e.addClassName(this.container,c.disableNextMonth));else if("today-future"===l.direction||"future"===l.direction)b>=l.months?(this.disablePreviousMonth=!1,e.removeClassName(this.container,c.disablePreviousMonth)):(this.disablePreviousMonth=!0,e.addClassName(this.container,c.disablePreviousMonth));if("today-past"===l.direction||"past"===l.direction)0>=a.add({y:1}).diff(moment(),"months")?(this.disableNextYear=!1,e.removeClassName(this.container,c.disableNextYear)):
(this.disableNextYear=!0,e.addClassName(this.container,c.disableNextYear));else if("today-future"===l.direction||"future"===l.direction)0<=a.subtract({y:1}).diff(moment(),"months")-(l.months-1)?(this.disablePreviousYear=!1,e.removeClassName(this.container,c.disablePreviousYear)):(this.disablePreviousYear=!0,e.addClassName(this.container,c.disablePreviousYear))}}};var q=function(a,b,c){var h=[];"string"===typeof a?a=a.split(b):e.isArray(a)||(a=[a]);var b=a.length,d=0;do a[d]&&h.push(moment(a[d],c).hours(12));
while(++d<b);return h};window.Kalendae=i;var e=i.util={isIE8:function(){return!(!/msie 8./i.test(navigator.appVersion)||/opera/i.test(navigator.userAgent)||!window.ActiveXObject||!XDomainRequest||window.msPerformance)},$:function(a){return"string"==typeof a?document.getElementById(a):a},$$:function(a){return document.querySelectorAll(a)},make:function(a,b,c){var e,a=document.createElement(a);if(b)for(e in b)b.hasOwnProperty(e)&&a.setAttribute(e,b[e]);c&&c.appendChild(a);return a},isVisible:function(a){return 0<
a.offsetWidth||0<a.offsetHeight},getStyle:function(a,b){var c;a.currentStyle?c=a.currentStyle[b]:window.getComputedStyle&&(c=window.getComputedStyle(a,null)[b]);return c},domReady:function(a){/in/.test(document.readyState)?setTimeout(function(){e.domReady(a)},9):a()},addEvent:function(a,b,c){var e=function(b){var b=b||window.event,e=c.apply(a,[b,b.target||b.srcElement]);!1===e&&(b.preventDefault?b.preventDefault():(b.returnValue=!1,b.cancelBubble=!0));return e};a.attachEvent?a.attachEvent("on"+b,
e):a.addEventListener(b,e,!1);return e},removeEvent:function(a,b,c){a.detachEvent?a.detachEvent("on"+b,c):a.removeEventListener(b,c,!1)},hasClassName:function(a,b){if(!(a=e.$(a)))return!1;var c=a.className;return 0<c.length&&(c==b||RegExp("(^|\\s)"+b+"(\\s|$)").test(c))},addClassName:function(a,b){if((a=e.$(a))&&!e.hasClassName(a,b))a.className+=(a.className?" ":"")+b},removeClassName:function(a,b){if(a=e.$(a))a.className=e.trimString(a.className.replace(RegExp("(^|\\s+)"+b+"(\\s+|$)")," "))},isFixed:function(a){do if("fixed"===
e.getStyle(a,"position"))return!0;while(a=a.offsetParent);return!1},scrollContainer:function(a){do{var b=e.getStyle(a,"overflow");if("auto"===b||"scroll"===b)return a}while((a=a.parentNode)&&a!=window.document.body);return null},getPosition:function(a,b){var c=a.offsetLeft,e=a.offsetTop,d={};if(!b)for(;a=a.offsetParent;)c+=a.offsetLeft,e+=a.offsetTop;d[0]=d.left=c;d[1]=d.top=e;return d},getHeight:function(a){return a.offsetHeight||a.scrollHeight},getWidth:function(a){return a.offsetWidth||a.scrollWidth},
trimString:function(a){return a.replace(/^\s+/,"").replace(/\s+$/,"")},merge:function(){for(var a=!0===arguments[0],b={},c=a?1:0;c<arguments.length;c++){var e=b,d=arguments[c];if("object"===typeof d){var f=void 0;for(f in d)d.hasOwnProperty(f)&&(a&&"object"===typeof e[f]&&"object"===typeof d[f]?_update(e[f],d[f]):e[f]=d[f])}}return b},isArray:function(a){return"[object Array]"==Object.prototype.toString.call(a)}};"function"===typeof document.addEventListener&&i.util.domReady(function(){for(var a=
e.$$(".auto-kal"),b=a.length,c,h;b--;)c=a[b],h=c.getAttribute("data-kal"),h=null==h||""==h?{}:(new Function("return {"+h+"};"))(),"INPUT"===c.tagName?new i.Input(c,h):new i(e.merge(h,{attachTo:c}))});i.Input=function(a,b){if("function"===typeof document.addEventListener||e.isIE8()){var c=this.input=e.$(a),h;if(!c||"INPUT"!==c.tagName)throw"First argument for Kalendae.Input must be an <input> element or a valid element id.";var d=this,f=d.classes;opts=d.settings=e.merge(d.defaults,b);opts.attachTo=
window.document.body;opts.selected?h=!0:opts.selected=c.value;i.call(d,opts);if(opts.closeButton){var g=e.make("a",{"class":f.closeButton},d.container);e.addEvent(g,"click",function(){c.blur()})}h&&(c.value=d.getSelected());h=d.container;var m=!1;h.style.display="none";e.addClassName(h,f.positioned);e.addEvent(h,"mousedown",function(){m=!0});e.addEvent(window.document,"mousedown",function(){m=!1});e.addEvent(c,"focus",function(){d.setSelected(this.value);d.show()});e.addEvent(c,"blur",function(){m?
(m=!1,c.focus()):d.hide()});e.addEvent(c,"keyup",function(){d.setSelected(this.value)});(f=e.scrollContainer(c))&&e.addEvent(f,"scroll",function(){c.blur()});d.subscribe("change",function(){c.value=d.getSelected()})}};i.Input.prototype=e.merge(i.prototype,{defaults:e.merge(i.prototype.defaults,{format:"MM/DD/YYYY",side:"bottom",closeButton:!0,offsetLeft:0,offsetTop:0}),classes:e.merge(i.prototype.classes,{positioned:"k-floating",closeButton:"k-btn-close"}),show:function(){var a=this.container,b=a.style,
c=this.input,h=e.getPosition(c),d=e.scrollContainer(c),d=d?d.scrollTop:0;b.display="";switch(opts.side){case "left":b.left=h.left-e.getWidth(a)+this.settings.offsetLeft+"px";b.top=h.top+this.settings.offsetTop-d+"px";break;case "right":b.left=h.left+e.getWidth(c)+"px";b.top=h.top+this.settings.offsetTop-d+"px";break;case "top":b.left=h.left+this.settings.offsetLeft+"px";b.top=h.top-e.getHeight(a)+this.settings.offsetTop-d+"px";break;default:b.left=h.left+this.settings.offsetLeft+"px",b.top=h.top+
e.getHeight(c)+this.settings.offsetTop-d+"px"}b.position=e.isFixed(c)?"fixed":"absolute";this.publish("show",this)},hide:function(){this.container.style.display="none";this.publish("hide",this)}});var t=function(a){a||(a=this);var b=a.c_||{};a.publish=function(a,e,d){for(var f=(a=b[a])?a.length:0,g;f--;)if(g=a[f].apply(e,d||[]),"boolean"===typeof g)return g};a.subscribe=function(a,e,d){b[a]||(b[a]=[]);d?b[a].push(e):b[a].unshift(e);return[a,e]};a.unsubscribe=function(a){for(var e=b[a[0]],a=a[1],d=
e?e.length:0;d--;)e[d]===a&&e.splice(d,1)}};i.moment=moment;moment.fn.stripTime=function(){this._d=new Date(864E5*Math.floor(this._d.valueOf()/864E5));return this};moment.fn.yearDay=function(a){var b=Math.floor(this._d/864E5);return"undefined"===typeof a?b:this.add({d:a-b})};m=moment().stripTime();"undefined"!==typeof jQuery&&"function"===typeof document.addEventListener&&(jQuery.fn.kalendae=function(a){this.each(function(b,c){"INPUT"===c.tagName?$(c).data("kalendae",new i.Input(c,a)):$(c).data("kalendae",
new i($.extend({},{attachTo:c},a)))});return this})})();
